<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Grand Hypno Generator</title>
<style>
:root{
  --bg:#070707;
  --panel:#0f0f10;
  --muted:#9aa0a6;
  --accent:#6aa6ff;
  --control:#121214;
  --border:#1e1e1f;
  --text:#e6e7e8;
  --danger:#ff7b6b;
}
html,body{height:100%;margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:var(--bg);color:var(--text)}
.wrap{max-width:1100px;margin:18px auto;padding:18px;background:linear-gradient(180deg,var(--panel),#070707);border-radius:12px;box-shadow:0 8px 40px rgba(0,0,0,0.7);border:1px solid var(--border)}
h1{margin:0 0 8px 0;font-size:20px}
.controls{display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin:12px 0}
label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
select,input[type="number"],input[type="range"],button,a{padding:8px 10px;border-radius:8px;border:1px solid var(--border);background:var(--control);color:var(--text);font-size:13px}
button.primary{background:linear-gradient(180deg,#1b1b1d,#141415);border:1px solid #242426;cursor:pointer}
button.ghost{background:transparent;border:1px dashed #222;color:var(--muted)}
button:disabled{opacity:0.45;cursor:not-allowed}
canvas{display:block;width:100%;height:auto;max-width:1280px;margin-top:12px;border-radius:10px;background:#000;border:1px solid #0b0b0b}
.row{display:flex;gap:10px;align-items:center}
.small{font-size:12px;color:var(--muted)}
.progress{height:10px;background:#0b0b0b;border-radius:6px;overflow:hidden;width:320px;margin-left:8px;border:1px solid #111}
.progress>i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#39f);width:0%}
#downloadLink{margin-left:8px;display:none;text-decoration:none;border:1px solid var(--border);padding:8px 10px;border-radius:8px}
footer{margin-top:14px;color:var(--muted);font-size:12px}
.danger{color:var(--danger);font-weight:600}
.consent{display:flex;gap:10px;align-items:center;margin-top:8px}
.muted-note{font-size:12px;color:var(--muted);max-width:900px}
@media (max-width:720px){.controls{flex-direction:column;align-items:flex-start}}
#dummyVideo{position:absolute;width:1px;height:1px;opacity:0;pointer-events:none;}
</style>
</head>
<body>
<div class="wrap">
<h1>Grand Hypno Generator — Ethical Mode</h1>

<div class="controls">
  <div>
    <label for="mood">Mood / Effect</label>
    <select id="mood">
      <option value="calm">Calm / Soothing</option>
      <option value="energetic">Energetic / Uplifting</option>
      <option value="hungry">Appetite / Food-invoking</option>
      <option value="focus">Focus / Concentration</option>
      <option value="anxious">Tension / Alerting</option>
      <option value="dreamy">Dreamy / Trance</option>
    </select>
  </div>
  <div>
    <label for="pattern">Entraining Pattern</label>
    <select id="pattern">
      <option value="softBlobs">Soft blobs</option>
      <option value="spiral">Slow Spiral</option>
      <option value="figure8">Figure-eight Flow</option>
      <option value="pulse">Breathing Pulse</option>
      <option value="warmOrbs">Warm Orbitals</option>
    </select>
  </div>
  <div>
    <label for="duration">Duration (sec) — max 3600</label>
    <input id="duration" type="number" min="1" max="3600" value="20"/>
  </div>
  <div>
    <label for="resolution">Resolution</label>
    <select id="resolution">
      <option value="1280x720">1280×720</option>
      <option value="960x540" selected>960×540</option>
      <option value="854x480">854×480</option>
      <option value="640x360">640×360</option>
    </select>
  </div>
  <div>
    <label for="fps">FPS</label>
    <input id="fps" type="number" min="12" max="60" value="30"/>
  </div>

  <div style="margin-left:auto;">
    <div class="row">
      <button id="startPreviewBtn" class="primary">Start Preview</button>
      <button id="stopPreviewBtn" class="ghost" disabled>Stop Preview</button>
      <button id="recordBtn" class="primary">Record</button>
      <button id="stopRecordBtn" class="ghost" disabled>Stop Recording</button>
      <a id="downloadLink">Download video</a>
    </div>
    <div class="row" style="margin-top:6px;">
      <div class="small">Status:</div>
      <div id="statusLabel" class="small" style="margin-left:8px;color:var(--muted)">preview stopped • not recording</div>
    </div>
  </div>
</div>

<div class="controls">
  <div class="row">
    <label class="small">Shape density</label>
    <input id="density" type="range" min="5" max="300" value="80"/>
  </div>
  <div class="row">
    <label class="small">Motion complexity</label>
    <input id="complexity" type="range" min="1" max="10" value="4"/>
  </div>
  <div class="row">
    <label class="small">Saturation</label>
    <input id="sat" type="range" min="0" max="200" value="100"/>
  </div>
  <div class="progress" title="Recording progress" style="margin-left:8px;">
    <i id="progressFill"></i>
  </div>
</div>

<div class="consent">
  <input id="consentBox" type="checkbox"/>
  <div>
    <div style="font-size:13px;color:var(--muted);">I confirm I have informed consent from participants for visual/audio entrainment and they are aware of potential effects (dizziness, nausea, headache, photosensitivity).</div>
    <div class="muted-note">To enable procedural audio or 'strong entrainment' patterns you must check this box. Recording with audio is disabled until consent is given.</div>
  </div>
</div>

<div style="margin-top:10px;">
  <label class="small">Enable procedural audio — requires consent</label>
  <input id="enableAudio" type="checkbox"/>
  <label class="small" style="margin-left:12px">Audio Mode</label>
  <select id="audioMode">
    <option value="none">None</option>
    <option value="alpha">Alpha (8–12 Hz)</option>
    <option value="theta">Theta (5–7 Hz)</option>
    <option value="beta">Beta (13–20 Hz)</option>
    <option value="infrasound">Infrasound-like (17–19 Hz)</option>
    <option value="appetite">Appetite ambient</option>
  </select>
</div>

<canvas id="stage" width="960" height="540"></canvas>
<video id="dummyVideo" playsinline muted></video>

<footer>
  <strong>Safety & ethics</strong> — Strong visual/audio entrainment. Must only be used with informed consent. Can affect mood, focus, and cause physical sensations. Stop immediately if anyone feels discomfort. <span class="danger">Do not use on children, pregnant people, or people with photosensitive epilepsy.</span>
</footer>

<script>
/* ------------------------------
Core DOM & state
------------------------------ */
const canvas = document.getElementById('stage');
const ctx = canvas.getContext('2d', { alpha:false });
let width = canvas.width, height = canvas.height;

const moodSelect = document.getElementById('mood');
const patternSelect = document.getElementById('pattern');
const startPreviewBtn = document.getElementById('startPreviewBtn');
const stopPreviewBtn = document.getElementById('stopPreviewBtn');
const recordBtn = document.getElementById('recordBtn');
const stopRecordBtn = document.getElementById('stopRecordBtn');
const downloadLink = document.getElementById('downloadLink');
const durationInput = document.getElementById('duration');
const resolutionInput = document.getElementById('resolution');
const fpsInput = document.getElementById('fps');
const densityInput = document.getElementById('density');
const complexityInput = document.getElementById('complexity');
const satInput = document.getElementById('sat');
const progressFill = document.getElementById('progressFill');
const statusLabel = document.getElementById('statusLabel');
const consentBox = document.getElementById('consentBox');
const enableAudio = document.getElementById('enableAudio');
const audioMode = document.getElementById('audioMode');
const dummyVideo = document.getElementById('dummyVideo');

let previewRunning = false;
let animationId = null;
let particles = [];
let mediaRecorder = null;
let recordedChunks = [];
let audioCtx = null;
let audioDestination = null;
let audioNodes = null;

/* ------------------------------
Mood presets & visuals
------------------------------ */
const moodPresets = {
  calm:{palette:['#9CCED7','#7FB8CF','#5EA8C5','#DFF6FB'],shape:'softBlobs',motion:'smooth'},
  energetic:{palette:['#FFD07A','#FF9A76','#FF6B6B','#FFB1C1'],shape:'pulse',motion:'fast'},
  hungry:{palette:['#FF7F50','#FFB347','#FFCC66'],shape:'warmOrbs',motion:'orbit'},
  focus:{palette:['#1E88E5','#0D47A1','#A3CEF5'],shape:'figure8',motion:'linear'},
  anxious:{palette:['#D9534F','#A72222','#FF6F61'],shape:'jitter',motion:'shaky'},
  dreamy:{palette:['#B39DDB','#CE93D8','#B3E5FC','#E1BEE7'],shape:'softBlobs',motion:'floaty'}
};

/* ------------------------------
Canvas & particles
------------------------------ */
function resizeCanvasFor(resString){
  const [w,h] = resString.split('x').map(n=>parseInt(n,10));
  canvas.width=w; canvas.height=h; width=w; height=h;
}

function initParticles(count=120,palette=['#fff']){
  particles=[];
  for(let i=0;i<count;i++){
    particles.push({
      x:Math.random()*width,
      y:Math.random()*height,
      size:5+Math.random()*50,
      color:palette[Math.floor(Math.random()*palette.length)],
      seed:Math.random(),
      angle:Math.random()*Math.PI*2
    });
  }
}

/* ------------------------------
Drawing helpers
------------------------------ */
function shade(hex,percent){
  const c=hex.replace('#','');
  const num=parseInt(c,16);
  let r=(num>>16), g=(num>>8)&0xff, b=num&0xff;
  r=Math.min(255, Math.max(0, Math.round(r*(1+percent))));
  g=Math.min(255, Math.max(0, Math.round(g*(1+percent))));
  b=Math.min(255, Math.max(0, Math.round(b*(1+percent))));
  return `rgb(${r},${g},${b})`;
}

/* Spiral / figure-8 / pulse movement */
function updateParticles(){
  const pattern=patternSelect.value;
  const density=densityInput.value;
  const complexity=complexityInput.value;
  const satFactor=satInput.value/100;
  particles.forEach(p=>{
    let speed=(Math.random()*0.5+0.2)*(complexity/5);
    switch(pattern){
      case 'spiral':
        p.angle+=0.01*speed;
        p.x=width/2+Math.cos(p.angle+p.seed)*100;
        p.y=height/2+Math.sin(p.angle+p.seed)*100;
      break;
      case 'figure8':
        p.x=width/2+Math.sin(p.angle*2)*150*Math.sin(p.seed*Math.PI);
        p.y=height/2+Math.sin(p.angle)*100;
        p.angle+=0.02*speed;
      break;
      case 'pulse':
        p.size=30+20*Math.sin(Date.now()/300+p.seed*Math.PI*2);
      break;
      case 'warmOrbs':
        p.angle+=0.01*speed;
        p.x=width/2+Math.cos(p.angle+p.seed)*100;
        p.y=height/2+Math.sin(p.angle+p.seed)*100;
      break;
      case 'softBlobs':
        p.x+=Math.sin(Date.now()/1000+p.seed*Math.PI*2)*0.5;
        p.y+=Math.cos(Date.now()/1000+p.seed*Math.PI*2)*0.5;
      break;
      case 'jitter':
        p.x+=Math.random()*2-1; p.y+=Math.random()*2-1;
      break;
    }
  });
}

function drawParticles(){
  ctx.clearRect(0,0,width,height);
  particles.forEach(p=>{
    ctx.beginPath();
    ctx.fillStyle=shade(p.color,Math.sin(Date.now()/1000+p.seed)*0.5);
    ctx.arc(p.x,p.y,p.size,0,Math.PI*2);
    ctx.fill();
  });
}

/* ------------------------------
Preview & animation
------------------------------ */
function startPreview(){
  if(previewRunning) return;
  previewRunning=true;
  resizeCanvasFor(resolutionInput.value);
  const mood=moodSelect.value;
  const palette=moodPresets[mood].palette;
  initParticles(densityInput.value,palette);
  statusLabel.textContent='preview running • not recording';
  function loop(){
    updateParticles();
    drawParticles();
    animationId=requestAnimationFrame(loop);
  }
  loop();
  if(enableAudio.checked && consentBox.checked) startAudio();
}

function stopPreview(){
  previewRunning=false;
  cancelAnimationFrame(animationId);
  statusLabel.textContent='preview stopped • not recording';
  stopAudio();
}

/* ------------------------------
MediaRecorder
------------------------------ */
function startRecording(){
  if(!previewRunning){alert('Start preview first'); return;}
  const fps=fpsInput.value;
  const stream=canvas.captureStream(fps);
  if(enableAudio.checked && consentBox.checked){
    if(audioDestination){
      stream.addTrack(audioDestination.stream.getAudioTracks()[0]);
    }
  }
  recordedChunks=[];
  mediaRecorder=new MediaRecorder(stream,{mimeType:'video/webm;codecs=vp9,opus'});
  mediaRecorder.ondataavailable=e=>{if(e.data.size>0) recordedChunks.push(e.data)};
  mediaRecorder.onstop=()=>{const blob=new Blob(recordedChunks,{type:'video/webm'});downloadLink.href=URL.createObjectURL(blob);downloadLink.style.display='inline-block';downloadLink.download='hypno_video.webm';};
  mediaRecorder.start();
  stopRecordBtn.disabled=false; recordBtn.disabled=true;
  statusLabel.textContent='preview running • recording';
  const maxDuration=parseInt(durationInput.value,10)*1000;
  setTimeout(()=>{if(mediaRecorder.state==='recording') stopRecording()},maxDuration);
}

function stopRecording(){
  if(mediaRecorder && mediaRecorder.state==='recording') mediaRecorder.stop();
  stopRecordBtn.disabled=true; recordBtn.disabled=false;
  statusLabel.textContent='preview running • not recording';
  progressFill.style.width='100%';
}

/* ------------------------------
Procedural audio
------------------------------ */
function startAudio(){
  if(audioCtx) return;
  audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  audioDestination=audioCtx.createMediaStreamDestination();
  audioNodes={};
  const mode=audioMode.value;
  if(mode==='none') return;
  
  if(mode==='infrasound' || mode==='alpha' || mode==='theta' || mode==='beta'){
    let baseFreq=mode==='infrasound'?18:mode==='alpha'?10:mode==='theta'?6:16;
    const oscillator=audioCtx.createOscillator();
    oscillator.type='sine';
    oscillator.frequency.value=baseFreq;
    const gainNode=audioCtx.createGain();
    gainNode.gain.value=0.02;
    oscillator.connect(gainNode).connect(audioDestination);
    oscillator.start();
    audioNodes.oscillator=oscillator;
  }
  if(mode==='appetite'){
    // low-volume high/low pulses to induce appetite associations
    const osc1=audioCtx.createOscillator();
    osc1.type='sine'; osc1.frequency.value=220;
    const gain1=audioCtx.createGain(); gain1.gain.value=0.01;
    osc1.connect(gain1).connect(audioDestination);
    osc1.start();
  }
  // Safari dummy video hack
  if(dummyVideo.paused){dummyVideo.play();}
}

function stopAudio(){
  if(audioCtx){audioCtx.close(); audioCtx=null; audioNodes=null;}
  dummyVideo.pause();
}

/* ------------------------------
Event listeners
------------------------------ */
startPreviewBtn.addEventListener('click',()=>{if(consentBox.checked) startPreview(); else alert('Check consent box first')});
stopPreviewBtn.addEventListener('click',stopPreview);
recordBtn.addEventListener('click',startRecording);
stopRecordBtn.addEventListener('click',stopRecording);
resolutionInput.addEventListener('change',()=>resizeCanvasFor(resolutionInput.value));

</script>
</body>
</html>
